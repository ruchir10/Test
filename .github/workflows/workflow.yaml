name: Sync S3 with GitHub

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install AWS CLI
        run: |
          pip install awscli

      - name: Sync .py files with S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          bucket_name="test21223"
          aws s3 sync . "s3://test21223" --include "*.py" --delete


deploy-terraform:
on:
    push:
        paths:
          - 'ifx/terraform/**'
        branches: [main]

     workflow_dispatch:

    jobs:
      # Job for deploying Terraform to the Team environment
      TerraformToTeam:
        runs-on: CAI-Enterprise
        environment: Team
        env:
          TARGET: team
        steps:
          - uses: actions/checkout@v2

          - name: Terraform Common
            with:

            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            ENVIRONMENT: "common"

          - name: Terraform Environment
            with:

            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            ENVIRONMENT: ${{ env.TARGET }}
            

      # Job for deploying Terraform to the Integration environment
      TerraformToInteg:
        runs-on: CAI-Enterprise
        needs: [TerraformToTeam]
        environment: Integ
        env:
          TARGET: integ
        steps:
          - uses: actions/checkout@v2

          - name: Terraform Common
            with:

            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            ENVIRONMENT: "common"

          - name: Terraform Environment
            with:

            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            ENVIRONMENT: ${{ env.TARGET }}

      # Job for deploying Terraform to the Production environment
      TerraformToProd:
        runs-on: CAI-Enterprise
        needs: [TerraformToInteg]
        environment: Production
        env:
          TARGET: prod
        steps:
          - uses: actions/checkout@v2

          - name: Terraform Common
            with:

            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            ENVIRONMENT: "common"

          - name: Terraform Environment
            with:
              
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            ENVIRONMENT: ${{ env.TARGET }}
